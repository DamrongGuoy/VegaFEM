name: Build

on: 
  push:
    branches:
      - '**'

  workflow_dispatch:

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  VCPKG_VERSION: 2022.11.14

jobs:

  Linux:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04,ubuntu-latest]
        compiler: [ {cpp: g++, c: gcc}, {cpp: clang++, c: clang} ]

    runs-on: ${{ matrix.os }}

    env:
      VCPKG_DEFAULT_TRIPLET: x64-linux

    steps:

    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Intel Apt repository
      timeout-minutes: 1
      run: |
        wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
        sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
        echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
        sudo apt update

    - name: Cache Intel oneAPI
      id: cache-intel
      uses: actions/cache@v3
      with:
        path: |
           /opt/intel/oneapi/setvars-vcvarsall.sh
           /opt/intel/oneapi/setvars.sh
           /opt/intel/oneapi/mkl
        key: oneAPI-MKL-${{ runner.os }}-${{ hashFiles('GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB') }}

    - name: Install Intel oneAPI
      timeout-minutes: 5
      if: steps.cache-intel.outputs.cache-hit != 'true'
      run: sudo apt install -y intel-oneapi-common-vars intel-oneapi-mkl intel-oneapi-mkl-devel intel-oneapi-tbb intel-oneapi-tbb-devel #devel needed for cmake and headers

    - name: Setup Intel oneAPI environment
      run: |
        source /opt/intel/oneapi/setvars.sh
        printenv >> $GITHUB_ENV

    - name: Setup ninja
      uses: seanmiddleditch/gha-setup-ninja@master

    - name: System dependencies
      run: |
        sudo apt install -y clang
        sudo apt install -y autoconf-archive #mpfr
        sudo apt install -y libopengl-dev libglu-dev libx11-dev libxrandr-dev libxi-dev libxxf86vm-dev #freeglut
        sudo apt install -y libxmu-dev libxi-dev libgl-dev #glew

    - name: Setup vcpkg
      id: setup-vcpkg
      uses: friendlyanon/setup-vcpkg@v1
      with: 
        committish: ${{ env.VCPKG_VERSION }}

    - name: Run vcpkg
      run: |
        ${{github.workspace}}/vcpkg/vcpkg install opengl freeglut glui glew cgal eigen3 intel-mkl tbb

    - name: Configure CMake
      env:
        CC:  ${{ matrix.compiler.c }}
        CXX: ${{ matrix.compiler.cpp }}
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        mkdir build
        cd build
        cmake \
          -G Ninja \
          -D CMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -D CMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DMKL_DIR=/opt/intel/oneapi/mkl/latest/lib/cmake/mkl \
          -S ../ \
          -B ./

    - name: Build
      # Build your program with the given configuration
      run: |
        cmake \
        --build ${{github.workspace}}/build \
        --config ${{env.BUILD_TYPE}}

    - name: Test
      working-directory: ${{github.workspace}}/build
      # Execute tests defined by the CMake configuration.  
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: |
        ctest -C ${{env.BUILD_TYPE}}

    - name: Upload build folder
      uses: actions/upload-artifact@v3
      with:
        name: Linux-build-dir
        path: ${{github.workspace}}/build
        retention-days: 2

  Windows:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2019,windows-latest]
        compiler: [ {cpp: cl.exe, c: cl.exe}, {cpp: clang++, c: clang} ]
    
    runs-on: ${{ matrix.os }}

    env:
      INTEL_WINDOWS_MKL_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/19040/w_onemkl_p_2022.2.1.19754_offline.exe
      VCPKG_DEFAULT_TRIPLET: x64-windows

    steps:

    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup ninja
      uses: seanmiddleditch/gha-setup-ninja@master

    - name: Restore cache for Intel oneAPI MKL
      id: cache-intel
      uses: actions/cache@v3 # mkl\latest symlink corrupted on cache restore https://github.com/actions/cache/issues/120
      with:
        path: |
          C:\Program Files (x86)\Intel\oneAPI\setvars-vcvarsall.bat
          C:\Program Files (x86)\Intel\oneAPI\setvars.bat
          C:\Program Files (x86)\Intel\oneAPI\mkl
        key: oneAPI-MKL-${{ runner.os }}-2022.2.1

    - name: Install Intel oneAPI MKL
      timeout-minutes: 25
      if: steps.cache-intel.outputs.cache-hit != 'true'
      run: scripts/install_windows.bat $env:INTEL_WINDOWS_MKL_URL

    - name: Set MKL environment variables
      run: |
        echo "ONEAPI_ROOT=C:\Program Files (x86)\Intel\oneAPI" >> $env:GITHUB_ENV
        echo "MKL_DIR=C:\Program Files (x86)\Intel\oneAPI\mkl\latest\lib\cmake\mkl" >> $env:GITHUB_ENV

    - name: Setup vcpkg
      id: setup-vcpkg
      uses: friendlyanon/setup-vcpkg@v1
      with: 
        committish: ${{ env.VCPKG_VERSION }}

    - name: Run vcpkg
      shell: cmd
      run: |
        ${{github.workspace}}\vcpkg\vcpkg.exe install intel-mkl
        ${{github.workspace}}\vcpkg\vcpkg.exe install opengl freeglut glui glew cgal eigen3 tbb

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      run: |
        cmake.exe `
          -G Ninja `
          -D CMAKE_C_COMPILER:FILEPATH=${{ matrix.compiler.c }} `
          -D CMAKE_CXX_COMPILER:FILEPATH=${{ matrix.compiler.cpp }} `
          -D CMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -D CMAKE_TOOLCHAIN_FILE:FILEPATH="${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -S ${{github.workspace}} `
          -B ${{github.workspace}}/build

    - name: Build VegaFEM
      # Build your program with the given configuration
      run: |
        cmake.exe `
          --build ${{github.workspace}}/build `
          --config ${{env.BUILD_TYPE}}

    - name: Upload build folder
      uses: actions/upload-artifact@v3
      with:
        name: Windows-build-dir
        path: ${{github.workspace}}/build
        retention-days: 2
